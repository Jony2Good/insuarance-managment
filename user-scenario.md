# Пользовательские сценарии

### Регистрация клиента 

1. Пользователь переходит по публичному URL компании (например, https://profit.insuarance.ru).

2. На главной странице приложения в верхнем правом угулу отображается кнопка "Войти / Зарегистрироваться".

3. Пользователь переходит на страницу регистрации и вводит:

	- имя;
	- адрес электронной почты;
	- пароль;
	- подтверждение пароля.

4. Нажимает кнопку «Зарегистрироваться».

5. Сервис аутентификации:

	- Проверяет уникальность email.
	- Сохраняет данные пользователя.
	- Создает учетную запись.
	- Публикует событие "user_registered" { user_id, email, name } в шину сообщений (RabbitMQ).

6. Сервис личного кабинета:

	- Получает событие "user_registered".
	- Создает профиль пользователя и виртуальный счет с балансом 0.

7. Сервис уведомлений:

	- Получает событие "user_registered".
	- Отправляет пользователю email с подтверждением регистрации.

8. Пользователь кликает на кнопку "Войти" и вводит:
	- адрес электронной почты;
	- пароль.

9. Для пользователя генерируется JWT-токен.

10. Пользователь автоматически перенаправляется в личный кабинет.

*Альтернативные сценарии:*

Ошибка валидации данных:

1. Если email уже занят или пароль не соответствует требованиям, система отображает сообщение об ошибке (например, "Email уже зарегистрирован" или "Пароль слишком слабый").
2. Пользователь возвращается к форме для исправления данных.

### Вход в личный кабинет

1. Пользователь переходит по публичному URL (https://profit.insurance.ru).

2. На главной странице пользователь нажимает кнопку "Войти", после чего система его перенаправляет на форму логина.

3. Пользователь вводит:

	- адрес электронной почты;
	- пароль.

4. Нажимает "Войти"

5. Сервис аутентификации:

	- Проверяет адрес электронной почты и пароль.
	- Выдает JWT-токен.

6. Пользователь перенаправляется в личный кабинет.

7. JWT-токен сохраняется в браузере.

*Альтернативные сценарии:*

1. Неверные учетные данные:

	- Система отображает сообщение: "Неверный электронный адрес или пароль".
	- Пользователь может повторить попытку.


### Работа с личным кабинетом

1. Просмотр и редактирование персональных данных.

	- В личном кабинете пользователь открывает вкладку "Персональные данные".
	- Отображается текущая информация, полученная из сервиса личного кабинета.
	- Пользователь редактирует необходимые поля (ФИО, email, пароль).
	- Нажимает "Сохранить изменения" — данные отправляются в сервис личного кабинета.
	- Сервис личного кабинета
		- Валидирует данные (например, формат телефона, уникальность email).
		- Обновляет профиль.

*Альтернативные сценарии:*

1. Ошибка валидации:

	- Если данные некорректны (например, неверный формат паспорта), отображается сообщение об ошибке.
	- Пользователь возвращается к форме для исправления.

### Управление виртуальным счётом

1. Пользователь переходит на вкладку "Виртуальный счёт".

2. Система запрашивает текущий баланс у Сервиса личного кабинета.

3. Отображается баланс и история транзакций (пополнения, списания).

4. Пользователь нажимает кнопку "Пополнить счёт".

5. Вводит сумму, нажимает "Пополнить".

6. После подтверждения транзакции:

    - Сервис оплаты обновляет баланс в сервисе личного кабинета.
	- Сервис уведомлений отправляет сообщение о пополнении.

7. Пользователь видит обновленный баланс в интерфейсе.

### Просмотр договоров

1. Пользователь открывает вкладку "Договоры".

2. Система запрашивает данные у Сервиса личного кабинета, который получает их из Сервиса оформления полисов.

3. Отображается список договоров с полями:Номер полиса.

	- Статус (Активен, Завершен, Ожидает оплаты, Черновик).
	- Дата создания.
	- Срок действия.

4. Для договоров в статусе "Ожидает оплаты" или "Черновик" доступна кнопка "Редактировать".

5. Пользователь нажимает "Редактировать", переходит в форму редактирования (аналогична форме на вкладке "Оформление полисов").

6. После редактирования пользователь сохраняет изменения, инициируя повторный расчет или оплату.

### Оформление и расчет полисов

1. Пользователь переходит на вкладку "Оформление полисов".

2. Система отображает форму с предзаполненными данными из Сервиса личного кабинета (ФИО, паспортные данные).

3. Заполняет форму:

	- Данные владельца (авто берутся из профиля).
	- Информация об автомобиле (VIN, гос.номер и пр.).
	- Срок действия полиса.

4. Нажимает кнопку "Рассчитать".

5. Сервис оформления передаёт данные в сервис расчета.

6. Сервис расчета:

	- Валидирует данные.
	- Отправляет запрос в сервис проверки авто.
	- Получает результат проверки (например, статус ТС, история).
	- Рассчитывает стоимость.
	- Возвращает результат (стоимость, коэффициенты).

7. Сервис проверки авто:

	  - Обращается к внешнему API (например, ГИБДД).
	  - Возвращает результат проверки (валидность, отсутствие залогов/угонов).

8. Система отображает пользователю:

	-  Итоговую стоимость полиса.
	- Детали расчета (коэффициенты, скидки).

9. Пользователь нажимает "Перейти к оплате" (переход к сценарию оплаты).

*Альтернативные сценарии:*

1. Ошибка проверки ТС:

	  - Если ТС не проходит проверку (например, в угоне), отображается сообщение: "Автомобиль не прошел проверку, уточните данные".
	  - Пользователь возвращается к форме для исправления.

2. Ошибка расчета:

	  - Если данные клиента или ТС некорректны, отображается сообщение: "Ошибка расчета, проверьте данные".
	  - Пользователь возвращается к форме.

### Оплата полисов

1. Пользователь на вкладке "Оформление полисов" после расчета нажимает "Оплатить".

2. Система отображает:

	  - Стоимость полиса.
	  - Текущий баланс виртуального счета.
	  - Опцию выбора способа оплаты (виртуальный счет или внешняя платежная система).
  
3. Пользователь выбирает "Оплатить с виртуального счета".

4. Сервис оплаты:

	  - Проверяет валидность расчета у Сервиса расчета полисов;
	  - Запрашивает баланс у Сервиса личного кабинета;
	  - Если средств достаточно, инициирует списание;
	  - Создает запись о платеже;
	  - Публикует событие.

5. Сервис оформления полисов:

	  - Получает событие;
	  - Обновляет статус полиса на "Активен";
	  - Передает данные в Сервис хранения и печати документов.

6. Сервис хранения и печати документов:

	  - Генерирует PDF-полис на основе шаблона;
	  - Сохраняет файл в хранилище;
	  - Публикует событие.
 
7. Сервис уведомлений:

	  - Получает событие;
	  - Отправляет пользователю email с прикрепленным PDF-полисом.

*Альтернативные сценарии:*

1. Недостаточно средств:

	  - Если баланс виртуального счета недостаточен, отображается сообщение: "Недостаточно средств, пополните счет".
	  - Пользователь перенаправляется на вкладку "Виртуальный счет" для пополнения.

2. Ошибка оплаты:

	  - Если списание не удалось, отображается сообщение: "Ошибка оплаты, попробуйте снова".
	  - Пользователь может повторить попытку или выбрать другой способ оплаты.
